#!/bin/bash
# Odoo Manager - Interactive Bash Menu
# A standalone script to manage Odoo instances without installing Python packages

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Configuration
CONFIG_DIR="$HOME/.config/odoo-manager"
DATA_DIR="$HOME/odoo-manager/data"
BACKUP_DIR="$HOME/odoo-manager/backups"
LOG_DIR="$HOME/odoo-manager/logs"
REPOS_DIR="$HOME/odoo-manager/repos"

# Ensure directories exist
mkdir -p "$CONFIG_DIR" "$DATA_DIR" "$BACKUP_DIR" "$LOG_DIR" "$REPOS_DIR"

# Check if Docker is installed
check_docker() {
    if ! command -v docker &> /dev/null; then
        echo -e "${RED}✗ Docker is not installed${NC}"
        return 1
    fi

    if ! docker info &> /dev/null; then
        echo -e "${RED}✗ Docker daemon is not running${NC}"
        return 1
    fi

    return 0
}

# Check if docker-compose is available
check_docker_compose() {
    if docker compose version &> /dev/null 2>&1; then
        echo "docker compose"
    elif docker-compose version &> /dev/null 2>&1; then
        echo "docker-compose"
    else
        echo ""
    fi
}

# Print header
print_header() {
    clear
    echo -e "${CYAN}${BOLD}╔════════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}${BOLD}║${NC}              ${GREEN}${BOLD}Odoo Manager${NC} ${CYAN}${BOLD}- Interactive Menu${NC}              ${CYAN}${BOLD}║${NC}"
    echo -e "${CYAN}${BOLD}╚════════════════════════════════════════════════════════════════╝${NC}"
    echo ""
}

# Print menu
print_menu() {
    echo -e "${BOLD}Main Menu:${NC}"
    echo ""
    echo -e "  ${GREEN}1)${NC} Instance Management"
    echo -e "  ${GREEN}2)${NC} Database Operations"
    echo -e "  ${GREEN}3)${NC} Module Management"
    echo -e "  ${GREEN}4)${NC} Backup & Restore"
    echo -e "  ${GREEN}5)${NC} View Logs"
    echo -e "  ${GREEN}6)${NC} Git Operations"
    echo -e "  ${GREEN}7)${NC} Environment Management"
    echo -e "  ${GREEN}8)${NC} Monitoring & Health"
    echo -e "  ${GREEN}9)${NC} Configuration"
    echo -e "  ${YELLOW}0)${NC} Exit"
    echo ""
}

# Instance Management submenu
instance_menu() {
    while true; do
        clear
        print_header
        echo -e "${BOLD}Instance Management${NC}"
        echo ""
        echo -e "  ${GREEN}1)${NC} List instances"
        echo -e "  ${GREEN}2)${NC} Create instance"
        echo -e "  ${GREEN}3)${NC} Start instance"
        echo -e "  ${GREEN}4)${NC} Stop instance"
        echo -e "  ${GREEN}5)${NC} Restart instance"
        echo -e "  ${GREEN}6)${NC} Instance status"
        echo -e "  ${GREEN}7)${NC} Remove instance"
        echo -e "  ${GREEN}8)${NC} Open Odoo shell"
        echo -e "  ${YELLOW}0)${NC} Back to main menu"
        echo ""
        echo -ne "${CYAN}Select option: ${NC}"
        read -r choice

        case $choice in
            1) list_instances ;;
            2) create_instance ;;
            3) start_instance ;;
            4) stop_instance ;;
            5) restart_instance ;;
            6) instance_status ;;
            7) remove_instance ;;
            8) open_shell ;;
            0) return ;;
            *) echo -e "${RED}Invalid option${NC}"; sleep 1 ;;
        esac
    done
}

# List instances
list_instances() {
    clear
    print_header
    echo -e "${BOLD}Instances List${NC}"
    echo ""

    if ! check_docker; then
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
        return
    fi

    # Get all Odoo containers
    containers=$(docker ps -a --filter "name=odoo-" --format "{{.Names}}" 2>/dev/null || true)

    if [ -z "$containers" ]; then
        echo -e "${YELLOW}No instances found${NC}"
    else
        printf "%-20s %-10s %-10s %-8s\n" "Name" "Status" "Port" "Deployment"
        printf "%-20s %-10s %-10s %-8s\n" "----" "------" "----" "-----------"

        for container in $containers; do
            name=${container#odoo-}
            if docker ps --filter "name=$container" --format "{{.Names}}" | grep -q "$container"; then
                status="${GREEN}running${NC}"
            else
                status="${RED}stopped${NC}"
            fi

            # Get port from container inspect
            port=$(docker inspect "$container" --format '{{range $p, $conf := .NetworkSettings.Ports}}{{if $p == "8069"}}{{$p}}::{{end}}{{end}}' 2>/dev/null | head -1 | cut -d':' -f2 | cut -d'-' -f1 || echo "N/A")

            # Check if it's Docker deployment
            deployment="Docker"

            printf "%-20s %-20s %-10s %-10s\n" "$name" "$status" "$port" "$deployment"
        done
    fi

    echo ""
    echo -ne "${YELLOW}Press Enter to continue...${NC}"
    read -r
}

# Create instance
create_instance() {
    clear
    print_header
    echo -e "${BOLD}Create New Instance${NC}"
    echo ""

    if ! check_docker; then
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
        return
    fi

    echo -ne "${CYAN}Instance name: ${NC}"
    read -r name

    if [ -z "$name" ]; then
        echo -e "${RED}Name cannot be empty${NC}"
        sleep 2
        return
    fi

    # Check if instance already exists
    if docker ps -a --filter "name=odoo-$name" --format "{{.Names}}" | grep -q "odoo-$name"; then
        echo -e "${RED}Instance '$name' already exists${NC}"
        sleep 2
        return
    fi

    echo -ne "${CYAN}Odoo version [master]: ${NC}"
    read -r version
    version=${version:-master}

    echo -ne "${CYAN}Edition [community]: ${NC}"
    read -r edition
    edition=${edition:-community}

    echo -ne "${CYAN}Port [8069]: ${NC}"
    read -r port
    port=${port:-8069}

    echo -ne "${CYAN}Workers [4]: ${NC}"
    read -r workers
    workers=${workers:-4}

    echo -ne "${CYAN}Database name [$name]: ${NC}"
    read -r db_name
    db_name=${db_name:-$name}

    echo -ne "${CYAN}Admin password [admin]: ${NC}"
    read -r admin_password
    admin_password=${admin_password:-admin}

    # Create instance directory
    instance_dir="$DATA_DIR/$name"
    mkdir -p "$instance_dir/addons"

    # Generate docker-compose.yml
    compose_file="$instance_dir/docker-compose.yml"

    image_suffix=""
    if [ "$edition" != "community" ]; then
        image_suffix="-$edition"
    fi

    cat > "$compose_file" <<EOF
version: '3.8'

services:
  odoo:
    image: odoo:$version$image_suffix
    container_name: odoo-$name
    depends_on:
      - postgres
    ports:
      - "${port}:8069"
    environment:
      HOST: postgres
      PORT: 5432
      USER: odoo
      PASSWORD: odoo
    volumes:
      - odoo-$name-data:/var/lib/odoo
      - ./addons:/mnt/extra-addons
    restart: unless-stopped
    command: --
      --db-host=postgres
      --db-port=5432
      --db-user=odoo
      --db-password=odoo
      --db-filter=^$db_name\$
      --workers=$workers
      --admin-password=$admin_password
      --without-demo=True

  postgres:
    image: postgres:15
    container_name: odoo-$name-db
    environment:
      POSTGRES_USER: odoo
      POSTGRES_PASSWORD: odoo
      POSTGRES_DB: postgres
    volumes:
      - odoo-$name-db-data:/var/lib/postgresql/data
    restart: unless-stopped

volumes:
  odoo-$name-data:
  odoo-$name-db-data:
EOF

    echo ""
    echo -e "${GREEN}✓ Instance '$name' created successfully${NC}"
    echo -e "  Config: $compose_file"
    echo -e "  Data: $instance_dir"
    echo ""
    echo -ne "${YELLOW}Start instance now? [y/N]: ${NC}"
    read -r start_now

    if [[ "$start_now" =~ ^[Yy]$ ]]; then
        cd "$instance_dir"
        $(check_docker_compose) -f docker-compose.yml up -d
        echo ""
        echo -e "${GREEN}✓ Instance '$name' started${NC}"
        echo -e "  Access at: http://localhost:$port"
    fi

    echo ""
    echo -ne "${YELLOW}Press Enter to continue...${NC}"
    read -r
}

# Start instance
start_instance() {
    clear
    print_header
    echo -e "${BOLD}Start Instance${NC}"
    echo ""

    if ! check_docker; then
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
        return
    fi

    # List instances
    containers=$(docker ps -a --filter "name=odoo-" --format "{{.Names}}" 2>/dev/null || true)

    if [ -z "$containers" ]; then
        echo -e "${YELLOW}No instances found${NC}"
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
        return
    fi

    echo -e "${CYAN}Available instances:${NC}"
    i=1
    for container in $containers; do
        name=${container#odoo-}
        echo "  $i) $name"
        ((i++))
    done

    echo ""
    echo -ne "${CYAN}Select instance number: ${NC}"
    read -r choice

    # Get selected instance
    instance=$(echo "$containers" | sed -n "${choice}p")
    if [ -z "$instance" ]; then
        echo -e "${RED}Invalid selection${NC}"
        sleep 2
        return
    fi

    name=${instance#odoo-}

    # Check if already running
    if docker ps --filter "name=$instance" --format "{{.Names}}" | grep -q "$instance"; then
        echo -e "${YELLOW}Instance '$name' is already running${NC}"
    else
        # Find docker-compose file
        compose_file="$DATA_DIR/$name/docker-compose.yml"

        if [ ! -f "$compose_file" ]; then
            echo -e "${RED}Cannot find docker-compose.yml for '$name'${NC}"
            echo ""
            echo -ne "${YELLOW}Press Enter to continue...${NC}"
            read -r
            return
        fi

        cd "$DATA_DIR/$name"
        $(check_docker_compose) -f docker-compose.yml up -d

        echo ""
        echo -e "${GREEN}✓ Instance '$name' started${NC}"
    fi

    echo ""
    echo -ne "${YELLOW}Press Enter to continue...${NC}"
    read -r
}

# Stop instance
stop_instance() {
    clear
    print_header
    echo -e "${BOLD}Stop Instance${NC}"
    echo ""

    if ! check_docker; then
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
        return
    fi

    # List running instances
    containers=$(docker ps --filter "name=odoo-" --format "{{.Names}}" 2>/dev/null || true)

    if [ -z "$containers" ]; then
        echo -e "${YELLOW}No running instances found${NC}"
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
        return
    fi

    echo -e "${CYAN}Running instances:${NC}"
    i=1
    for container in $containers; do
        name=${container#odoo-}
        echo "  $i) $name"
        ((i++))
    done

    echo ""
    echo -ne "${CYAN}Select instance number: ${NC}"
    read -r choice

    # Get selected instance
    instance=$(echo "$containers" | sed -n "${choice}p")
    if [ -z "$instance" ]; then
        echo -e "${RED}Invalid selection${NC}"
        sleep 2
        return
    fi

    name=${instance#odoo-}

    # Stop instance
    docker stop "$instance" > /dev/null 2>&1

    echo ""
    echo -e "${GREEN}✓ Instance '$name' stopped${NC}"
    echo ""
    echo -ne "${YELLOW}Press Enter to continue...${NC}"
    read -r
}

# Restart instance
restart_instance() {
    clear
    print_header
    echo -e "${BOLD}Restart Instance${NC}"
    echo ""

    if ! check_docker; then
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
        return
    fi

    # List running instances
    containers=$(docker ps --filter "name=odoo-" --format "{{.Names}}" 2>/dev/null || true)

    if [ -z "$containers" ]; then
        echo -e "${YELLOW}No running instances found${NC}"
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
        return
    fi

    echo -e "${CYAN}Running instances:${NC}"
    i=1
    for container in $containers; do
        name=${container#odoo-}
        echo "  $i) $name"
        ((i++))
    done

    echo ""
    echo -ne "${CYAN}Select instance number: ${NC}"
    read -r choice

    # Get selected instance
    instance=$(echo "$containers" | sed -n "${choice}p")
    if [ -z "$instance" ]; then
        echo -e "${RED}Invalid selection${NC}"
        sleep 2
        return
    fi

    name=${instance#odoo-}

    # Restart instance
    docker restart "$instance" > /dev/null 2>&1

    echo ""
    echo -e "${GREEN}✓ Instance '$name' restarted${NC}"
    echo ""
    echo -ne "${YELLOW}Press Enter to continue...${NC}"
    read -r
}

# Instance status
instance_status() {
    clear
    print_header
    echo -e "${BOLD}Instance Status${NC}"
    echo ""

    if ! check_docker; then
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
        return
    fi

    # List instances
    containers=$(docker ps -a --filter "name=odoo-" --format "{{.Names}}" 2>/dev/null || true)

    if [ -z "$containers" ]; then
        echo -e "${YELLOW}No instances found${NC}"
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
        return
    fi

    echo -e "${CYAN}Select instance:${NC}"
    i=1
    for container in $containers; do
        name=${container#odoo-}
        echo "  $i) $name"
        ((i++))
    done

    echo ""
    echo -ne "${CYAN}Select instance number: ${NC}"
    read -r choice

    # Get selected instance
    instance=$(echo "$containers" | sed -n "${choice}p")
    if [ -z "$instance" ]; then
        echo -e "${RED}Invalid selection${NC}"
        sleep 2
        return
    fi

    name=${instance#odoo-}

    clear
    print_header
    echo -e "${BOLD}Instance: $name${NC}"
    echo ""

    # Container status
    if docker ps --filter "name=$instance" --format "{{.Names}}" | grep -q "$instance"; then
        echo -e "  Status: ${GREEN}Running${NC}"
    else
        echo -e "  Status: ${RED}Stopped${NC}"
    fi

    # Container info
    echo ""
    echo -e "${BOLD}Container Information:${NC}"

    # Image
    image=$(docker inspect "$instance" --format '{{.Config.Image}}' 2>/dev/null)
    echo "  Image: $image"

    # Ports
    ports=$(docker port "$instance" 2>/dev/null | head -1)
    if [ -n "$ports" ]; then
        echo "  Ports: $ports"
    fi

    # Volumes
    echo ""
    echo -e "${BOLD}Volumes:${NC}"
    docker inspect "$instance" --format '{{range .Mounts}}  {{.Source}} -> {{.Destination}}{{end}}' 2>/dev/null | head -5 | while read -r line; do
        echo "  $line"
    done

    # Resource usage
    echo ""
    echo -e "${BOLD}Resource Usage:${NC}"
    stats=$(docker stats "$instance" --no-stream --format "table {{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}" 2>/dev/null)
    if [ -n "$stats" ]; then
        echo "$stats" | tail -1 | while read -r cpu mem io; do
            echo "  CPU: $cpu"
            echo "  Memory: $mem"
            echo "  Network I/O: $io"
        done
    fi

    echo ""
    echo -ne "${YELLOW}Press Enter to continue...${NC}"
    read -r
}

# Remove instance
remove_instance() {
    clear
    print_header
    echo -e "${BOLD}Remove Instance${NC}"
    echo ""

    if ! check_docker; then
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
        return
    fi

    # List instances
    containers=$(docker ps -a --filter "name=odoo-" --format "{{.Names}}" 2>/dev/null || true)

    if [ -z "$containers" ]; then
        echo -e "${YELLOW}No instances found${NC}"
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
        return
    fi

    echo -e "${CYAN}Available instances:${NC}"
    i=1
    for container in $containers; do
        name=${container#odoo-}
        echo "  $i) $name"
        ((i++))
    done

    echo ""
    echo -ne "${CYAN}Select instance number: ${NC}"
    read -r choice

    # Get selected instance
    instance=$(echo "$containers" | sed -n "${choice}p")
    if [ -z "$instance" ]; then
        echo -e "${RED}Invalid selection${NC}"
        sleep 2
        return
    fi

    name=${instance#odoo-}

    # Confirm removal
    echo ""
    echo -ne "${RED}Are you sure you want to remove instance '$name'? [y/N]: ${NC}"
    read -r confirm

    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
        return
    fi

    # Stop if running
    if docker ps --filter "name=$instance" --format "{{.Names}}" | grep -q "$instance"; then
        docker stop "$instance" > /dev/null 2>&1
    fi

    # Remove container
    docker rm "$instance" > /dev/null 2>&1

    # Remove database container if exists
    db_container="odoo-$name-db"
    if docker ps -a --filter "name=$db_container" --format "{{.Names}}" | grep -q "$db_container"; then
        docker stop "$db_container" > /dev/null 2>&1
        docker rm "$db_container" > /dev/null 2>&1
    fi

    # Optionally remove data
    echo ""
    echo -ne "${YELLOW}Remove data directories? [y/N]: ${NC}"
    read -r remove_data

    if [[ "$remove_data" =~ ^[Yy]$ ]]; then
        # Remove volumes
        docker volume rm "odoo-$name-data" 2>/dev/null || true
        docker volume rm "odoo-$name-db-data" 2>/dev/null || true

        # Remove instance directory
        if [ -d "$DATA_DIR/$name" ]; then
            rm -rf "$DATA_DIR/$name"
        fi

        echo -e "  Data removed"
    fi

    echo ""
    echo -e "${GREEN}✓ Instance '$name' removed${NC}"
    echo ""
    echo -ne "${YELLOW}Press Enter to continue...${NC}"
    read -r
}

# Open Odoo shell
open_shell() {
    clear
    print_header
    echo -e "${BOLD}Open Odoo Shell${NC}"
    echo ""

    if ! check_docker; then
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
        return
    fi

    # List running instances
    containers=$(docker ps --filter "name=odoo-" --format "{{.Names}}" 2>/dev/null || true)

    if [ -z "$containers" ]; then
        echo -e "${YELLOW}No running instances found${NC}"
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
        return
    fi

    echo -e "${CYAN}Running instances:${NC}"
    i=1
    for container in $containers; do
        name=${container#odoo-}
        echo "  $i) $name"
        ((i++))
    done

    echo ""
    echo -ne "${CYAN}Select instance number: ${NC}"
    read -r choice

    # Get selected instance
    instance=$(echo "$containers" | sed -n "${choice}p")
    if [ -z "$instance" ]; then
        echo -e "${RED}Invalid selection${NC}"
        sleep 2
        return
    fi

    name=${instance#odoo-}

    echo ""
    echo -e "${CYAN}Opening shell for '$name'...${NC}"
    echo -e "Type 'exit' to return to menu"
    echo ""

    # Open shell
    docker exec -it "$instance" /bin/bash || docker exec -it "$instance" /bin/sh

    echo ""
    echo -ne "${YELLOW}Press Enter to continue...${NC}"
    read -r
}

# Database Operations submenu
database_menu() {
    while true; do
        clear
        print_header
        echo -e "${BOLD}Database Operations${NC}"
        echo ""
        echo -e "  ${GREEN}1)${NC} List databases"
        echo -e "  ${GREEN}2)${NC} Create database"
        echo -e "  ${GREEN}3)${NC} Drop database"
        echo -e "  ${GREEN}4)${NC} Backup database"
        echo -e "  ${GREEN}5)${NC} List backups"
        echo -e "  ${YELLOW}0)${NC} Back to main menu"
        echo ""
        echo -ne "${CYAN}Select option: ${NC}"
        read -r choice

        case $choice in
            1) list_databases ;;
            2) create_database ;;
            3) drop_database ;;
            4) backup_database ;;
            5) list_backups ;;
            0) return ;;
            *) echo -e "${RED}Invalid option${NC}"; sleep 1 ;;
        esac
    done
}

# List databases
list_databases() {
    clear
    print_header
    echo -e "${BOLD}List Databases${NC}"
    echo ""

    if ! check_docker; then
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
        return
    fi

    # Get running instances
    containers=$(docker ps --filter "name=odoo-" --filter "name=-db" --format "{{.Names}}" 2>/dev/null || true)

    if [ -z "$containers" ]; then
        echo -e "${YELLOW}No database containers found${NC}"
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
        return
    fi

    echo -e "${CYAN}Select database container:${NC}"
    i=1
    for container in $containers; do
        name=${container% -db}
        name=${name#odoo-}
        echo "  $i) $name"
        ((i++))
    done

    echo ""
    echo -ne "${CYAN}Select container number: ${NC}"
    read -r choice

    container=$(echo "$containers" | sed -n "${choice}p")
    if [ -z "$container" ]; then
        echo -e "${RED}Invalid selection${NC}"
        sleep 2
        return
    fi

    clear
    print_header
    echo -e "${BOLD}Databases in:${NC} ${container#odoo-}"
    echo ""

    # List databases
    docker exec "$container" psql -U odoo -d postgres -c "\l" 2>/dev/null || echo "Failed to list databases"

    echo ""
    echo -ne "${YELLOW}Press Enter to continue...${NC}"
    read -r
}

# Create database
create_database() {
    clear
    print_header
    echo -e "${BOLD}Create Database${NC}"
    echo ""

    echo -ne "${CYAN}Database name: ${NC}"
    read -r db_name

    if [ -z "$db_name" ]; then
        echo -e "${RED}Database name cannot be empty${NC}"
        sleep 2
        return
    fi

    # Get database container
    containers=$(docker ps --filter "name=odoo-" --filter "name=-db" --format "{{.Names}}" 2>/dev/null || true)

    if [ -z "$containers" ]; then
        echo -e "${RED}No database containers found${NC}"
        sleep 2
        return
    fi

    echo ""
    echo -e "${CYAN}Select database container:${NC}"
    i=1
    for container in $containers; do
        name=${container% -db}
        name=${name#odoo-}
        echo "  $i) $name"
        ((i++))
    done

    echo ""
    echo -ne "${CYAN}Select container number: ${NC}"
    read -r choice

    container=$(echo "$containers" | sed -n "${choice}p")
    if [ -z "$container" ]; then
        echo -e "${RED}Invalid selection${NC}"
        sleep 2
        return
    fi

    # Create database
    if docker exec "$container" psql -U odoo -d postgres -c "CREATE DATABASE \"$db_name\"";" 2>/dev/null; then
        echo ""
        echo -e "${GREEN}✓ Database '$db_name' created${NC}"
    else
        echo ""
        echo -e "${RED}✗ Failed to create database${NC}"
    fi

    echo ""
    echo -ne "${YELLOW}Press Enter to continue...${NC}"
    read -r
}

# Drop database
drop_database() {
    clear
    print_header
    echo -e "${BOLD}Drop Database${NC}"
    echo ""

    # Get database container
    containers=$(docker ps --filter "name=odoo-" --filter "name=-db" --format "{{.Names}}" 2>/dev/null || true)

    if [ -z "$containers" ]; then
        echo -e "${RED}No database containers found${NC}"
        sleep 2
        return
    fi

    echo -e "${CYAN}Select database container:${NC}"
    i=1
    for container in $containers; do
        name=${container% -db}
        name=${name#odoo-}
        echo "  $i) $name"
        ((i++))
    done

    echo ""
    echo -ne "${CYAN}Select container number: ${NC}"
    read -r choice

    container=$(echo "$containers" | sed -n "${choice}p")
    if [ -z "$container" ]; then
        echo -e "${RED}Invalid selection${NC}"
        sleep 2
        return
    fi

    echo ""
    echo -ne "${CYAN}Database name: ${NC}"
    read -r db_name

    if [ -z "$db_name" ]; then
        echo -e "${RED}Database name cannot be empty${NC}"
        sleep 2
        return
    fi

    # Confirm
    echo ""
    echo -ne "${RED}Are you sure you want to drop database '$db_name'? [y/N]: ${NC}"
    read -r confirm

    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
        return
    fi

    # Drop database
    if docker exec "$container" psql -U odoo -d postgres -c "DROP DATABASE \"$db_name\";" 2>/dev/null; then
        echo ""
        echo -e "${GREEN}✓ Database '$db_name' dropped${NC}"
    else
        echo ""
        echo -e "${RED}✗ Failed to drop database${NC}"
    fi

    echo ""
    echo -ne "${YELLOW}Press Enter to continue...${NC}"
    read -r
}

# Backup database
backup_database() {
    clear
    print_header
    echo -e "${BOLD}Backup Database${NC}"
    echo ""

    # Get running instances
    containers=$(docker ps --filter "name=odoo-" --filter "name=-db" --format "{{.Names}}" 2>/dev/null || true)

    if [ -z "$containers" ]; then
        echo -e "${YELLOW}No database containers found${NC}"
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
        return
    fi

    echo -e "${CYAN}Select database container:${NC}"
    i=1
    for container in $containers; do
        name=${container% -db}
        name=${name#odoo-}
        echo "  $i) $name"
        ((i++))
    done

    echo ""
    echo -ne "${CYAN}Select container number: ${NC}"
    read -r choice

    container=$(echo "$containers" | sed -n "${choice}p")
    if [ -z "$container" ]; then
        echo -e "${RED}Invalid selection${NC}"
        sleep 2
        return
    fi

    instance_name=${container#odoo-}
    instance_name=${instance_name% -db}

    echo ""
    echo -ne "${CYAN}Database name (or press Enter for all): ${NC}"
    read -r db_name

    if [ -z "$db_name" ]; then
        db_name="all"
    fi

    # Create backup filename
    timestamp=$(date +%Y%m%d_%H%M%S)
    backup_file="$BACKUP_DIR/${instance_name}_${db_name}_${timestamp}.dump"
    mkdir -p "$BACKUP_DIR"

    echo ""
    echo -e "${CYAN}Creating backup...${NC}"

    # Run backup
    if [ "$db_name" = "all" ]; then
        docker exec "$container" pg_dumpall -U odoo > "$backup_file" 2>/dev/null
    else
        docker exec "$container" pg_dump -U odoo -d "$db_name" > "$backup_file" 2>/dev/null
    fi

    if [ $? -eq 0 ]; then
        size=$(du -h "$backup_file" | cut -f1)
        echo ""
        echo -e "${GREEN}✓ Backup created${NC}"
        echo "  File: $backup_file"
        echo "  Size: $size"
    else
        echo ""
        echo -e "${RED}✗ Backup failed${NC}"
        rm -f "$backup_file"
    fi

    echo ""
    echo -ne "${YELLOW}Press Enter to continue...${NC}"
    read -r
}

# List backups
list_backups() {
    clear
    print_header
    echo -e "${BOLD}Backups${NC}"
    echo ""

    if [ ! -d "$BACKUP_DIR" ] || [ -z "$(ls -A $BACKUP_DIR)" ]; then
        echo -e "${YELLOW}No backups found${NC}"
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
        return
    fi

    printf "%-40s %-15s %-15s\n" "Filename" "Size" "Date"
    printf "%-40s %-15s %-15s\n" "--------" "----" "----"

    for backup in "$BACKUP_DIR"/*.dump "$BACKUP_DIR"/*.sql; do
        if [ -f "$backup" ]; then
            filename=$(basename "$backup")
            size=$(du -h "$backup" | cut -f1)
            date=$(stat -f "%Sm" -t "%Y-%m-%d %H:%M" "$backup" 2>/dev/null || stat -c "%y" "$backup" 2>/dev/null)
            printf "%-40s %-15s %-15s\n" "$filename" "$size" "$date"
        fi
    done 2>/dev/null

    echo ""
    echo -ne "${YELLOW}Press Enter to continue...${NC}"
    read -r
}

# Module Management submenu
module_menu() {
    while true; do
        clear
        print_header
        echo -e "${BOLD}Module Management${NC}"
        echo ""
        echo -e "  ${GREEN}1)${NC} List modules"
        echo -e "  ${GREEN}2)${NC} Install module"
        echo -e "  ${GREEN}3)${NC} Uninstall module"
        echo -e "  ${GREEN}4)${NC} Update module"
        echo -e "  ${GREEN}5)${NC} Update all modules"
        echo -e "  ${YELLOW}0)${NC} Back to main menu"
        echo ""
        echo -ne "${CYAN}Select option: ${NC}"
        read -r choice

        case $choice in
            1) list_modules ;;
            2) install_module ;;
            3) uninstall_module ;;
            4) update_module ;;
            5) update_all_modules ;;
            0) return ;;
            *) echo -e "${RED}Invalid option${NC}"; sleep 1 ;;
        esac
    done
}

# List modules
list_modules() {
    clear
    print_header
    echo -e "${BOLD}List Modules${NC}"
    echo ""

    if ! check_docker; then
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
        return
    fi

    # Get running instances
    containers=$(docker ps --filter "name=odoo-" --filter "name=-db" --format "{{.Names}}" 2>/dev/null || true)

    if [ -z "$containers" ]; then
        echo -e "${YELLOW}No running instances found${NC}"
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
        return
    fi

    echo -e "${CYAN}Select instance:${NC}"
    i=1
    for container in $containers; do
        name=${container% -db}
        name=${name#odoo-}
        echo "  $i) $name"
        ((i++))
    done

    echo ""
    echo -ne "${CYAN}Select instance number: ${NC}"
    read -r choice

    container=$(echo "$containers" | sed -n "${choice}p")
    if [ -z "$container" ]; then
        echo -e "${RED}Invalid selection${NC}"
        sleep 2
        return
    fi

    # Get Odoo container
    odoo_container="${container%-db}"
    if [ ! -z "$odoo_container" ]; then
        odoo_container="${odoo_container}-db"
    fi
    odoo_container="${odoo_container% -db}"

    echo ""
    echo -ne "${CYAN}Show [i]nstalled or [a]vailable modules? [i/a]: ${NC}"
    read -r show_type

    echo ""
    echo -ne "${CYAN}Filter (optional): ${NC}"
    read -r filter

    clear
    print_header
    echo -e "${BOLD}Modules${NC}"
    echo ""

    # Build odoo shell command
    if [ "$show_type" = "a" ]; then
        docker exec "$odoo_container" python /usr/bin/odoo shell -c "modules = registry.load(cr.dbname); print('\\n'.join(sorted(m.name for m in modules)))" -d postgres 2>/dev/null | tail -n +2 | grep -i "${filter:-}" || echo "No modules found"
    else
        docker exec "$odoo_container" python /usr/bin/odoo shell -c "modules = registry['ir.module.module'].search([]); print('\\n'.join('%s - %s' % (m.name, m.state) for m in modules))" -d postgres 2>/dev/null | tail -n +2 | grep -i "${filter:-}" || echo "No modules found"
    fi

    echo ""
    echo -ne "${YELLOW}Press Enter to continue...${NC}"
    read -r
}

# Install module
install_module() {
    clear
    print_header
    echo -e "${BOLD}Install Module${NC}"
    echo ""

    if ! check_docker; then
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
        return
    fi

    # Get running instances
    containers=$(docker ps --filter "name=odoo-" --format "{{.Names}}" 2>/dev/null || true)

    if [ -z "$containers" ]; then
        echo -e "${YELLOW}No running instances found${NC}"
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
        return
    fi

    echo -e "${CYAN}Select instance:${NC}"
    i=1
    for container in $containers; do
        name=${container#odoo-}
        echo "  $i) $name"
        ((i++))
    done

    echo ""
    echo -ne "${CYAN}Select instance number: ${NC}"
    read -r choice

    instance=$(echo "$containers" | sed -n "${choice}p")
    if [ -z "$instance" ]; then
        echo -e "${RED}Invalid selection${NC}"
        sleep 2
        return
    fi

    echo ""
    echo -ne "${CYAN}Module name(s) (comma-separated): ${NC}"
    read -r modules

    if [ -z "$modules" ]; then
        echo -e "${RED}Module name cannot be empty${NC}"
        sleep 2
        return
    fi

    echo ""
    echo -e "${CYAN}Installing modules...${NC}"

    # Install modules
    IFS=',' read -ra ADDR <<< "$modules"
    for module in "${ADDR[@]}"; do
        module=$(echo "$module" | xargs) # trim whitespace
        echo "  Installing $module..."
        docker exec "$instance" python /usr/bin/odoo -d postgres -i "$module" --stop-after-init 2>/dev/null &
    done

    wait

    echo ""
    echo -e "${GREEN}✓ Modules installed${NC}"
    echo -e "${YELLOW}Note: Restart the instance to apply changes${NC}"

    echo ""
    echo -ne "${YELLOW}Press Enter to continue...${NC}"
    read -r
}

# Uninstall module
uninstall_module() {
    clear
    print_header
    echo -e "${BOLD}Uninstall Module${NC}"
    echo ""

    if ! check_docker; then
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
        return
    fi

    # Get running instances
    containers=$(docker ps --filter "name=odoo-" --format "{{.Names}}" 2>/dev/null || true)

    if [ -z "$containers" ]; then
        echo -e "${YELLOW}No running instances found${NC}"
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
        return
    fi

    echo -e "${CYAN}Select instance:${NC}"
    i=1
    for container in $containers; do
        name=${container#odoo-}
        echo "  $i) $name"
        ((i++))
    done

    echo ""
    echo -ne "${CYAN}Select instance number: ${NC}"
    read -r choice

    instance=$(echo "$containers" | sed -n "${choice}p")
    if [ -z "$instance" ]; then
        echo -e "${RED}Invalid selection${NC}"
        sleep 2
        return
    fi

    echo ""
    echo -ne "${CYAN}Module name: ${NC}"
    read -r module

    if [ -z "$module" ]; then
        echo -e "${RED}Module name cannot be empty${NC}"
        sleep 2
        return
    fi

    # Uninstall module
    echo ""
    echo -e "${CYAN}Uninstalling module...${NC}"
    docker exec "$instance" python /usr/bin/odoo -d postgres --uninstall "$module" --stop-after-init 2>/dev/null &

    wait

    echo ""
    echo -e "${GREEN}✓ Module '$module' uninstalled${NC}"

    echo ""
    echo -ne "${YELLOW}Press Enter to continue...${NC}"
    read -r
}

# Update module
update_module() {
    clear
    print_header
    echo -e "${BOLD}Update Module${NC}"
    echo ""

    if ! check_docker; then
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
        return
    fi

    # Get running instances
    containers=$(docker ps --filter "name=odoo-" --format "{{.Names}}" 2>/dev/null || true)

    if [ -z "$containers" ]; then
        echo -e "${YELLOW}No running instances found${NC}"
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
        return
    fi

    echo -e "${CYAN}Select instance:${NC}"
    i=1
    for container in $containers; do
        name=${container#odoo-}
        echo "  $i) $name"
        ((i++))
    done

    echo ""
    echo -ne "${CYAN}Select instance number: ${NC}"
    read -r choice

    instance=$(echo "$containers" | sed -n "${choice}p")
    if [ -z "$instance" ]; then
        echo -e "${RED}Invalid selection${NC}"
        sleep 2
        return
    fi

    echo ""
    echo -ne "${CYAN}Module name (or 'all'): ${NC}"
    read -r module

    if [ -z "$module" ]; then
        echo -e "${RED}Module name cannot be empty${NC}"
        sleep 2
        return
    fi

    # Update module
    echo ""
    echo -e "${CYAN}Updating module...${NC}"

    if [ "$module" = "all" ]; then
        docker exec "$instance" python /usr/bin/odoo -d postgres -u all --stop-after-init 2>/dev/null &
    else
        docker exec "$instance" python /usr/bin/odoo -d postgres -u "$module" --stop-after-init 2>/dev/null &
    fi

    wait

    echo ""
    echo -e "${GREEN}✓ Module(s) updated${NC}"

    echo ""
    echo -ne "${YELLOW}Press Enter to continue...${NC}"
    read -r
}

# Update all modules
update_all_modules() {
    update_module
}

# View Logs submenu
logs_menu() {
    while true; do
        clear
        print_header
        echo -e "${BOLD}View Logs${NC}"
        echo ""
        echo -e "  ${GREEN}1)${NC} View instance logs"
        echo -e "  ${GREEN}2)${NC} View database logs"
        echo -e "  ${GREEN}3)${NC} Follow logs (live)"
        echo -e "  ${YELLOW}0)${NC} Back to main menu"
        echo ""
        echo -ne "${CYAN}Select option: ${NC}"
        read -r choice

        case $choice in
            1) view_logs ;;
            2) view_db_logs ;;
            3) follow_logs ;;
            0) return ;;
            *) echo -e "${RED}Invalid option${NC}"; sleep 1 ;;
        esac
    done
}

# View logs
view_logs() {
    clear
    print_header
    echo -e "${BOLD}View Instance Logs${NC}"
    echo ""

    if ! check_docker; then
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
        return
    fi

    # Get instances
    containers=$(docker ps -a --filter "name=odoo-" --format "{{.Names}}" 2>/dev/null || true)

    if [ -z "$containers" ]; then
        echo -e "${YELLOW}No instances found${NC}"
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
        return
    fi

    echo -e "${CYAN}Select instance:${NC}"
    i=1
    for container in $containers; do
        name=${container#odoo-}
        echo "  $i) $name"
        ((i++))
    done

    echo ""
    echo -ne "${CYAN}Select instance number: ${NC}"
    read -r choice

    instance=$(echo "$containers" | sed -n "${choice}p")
    if [ -z "$instance" ]; then
        echo -e "${RED}Invalid selection${NC}"
        sleep 2
        return
    fi

    echo ""
    echo -ne "${CYAN}Number of lines [100]: ${NC}"
    read -r lines
    lines=${lines:-100}

    clear
    print_header
    echo -e "${BOLD}Logs: ${instance#odoo-}${NC}"
    echo ""
    echo -e "${DIM}(Press 'q' to return to menu)${NC}"
    echo ""

    # Show logs with pagination
    docker logs --tail "$lines" "$instance" 2>/dev/null | less -R || docker logs --tail "$lines" "$instance" 2>/dev/null

    echo ""
    echo -ne "${YELLOW}Press Enter to continue...${NC}"
    read -r
}

# View database logs
view_db_logs() {
    clear
    print_header
    echo -e "${BOLD}View Database Logs${NC}"
    echo ""

    if ! check_docker; then
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
        return
    fi

    # Get database containers
    containers=$(docker ps -a --filter "name=odoo-" --filter "name=-db" --format "{{.Names}}" 2>/dev/null || true)

    if [ -z "$containers" ]; then
        echo -e "${YELLOW}No database containers found${NC}"
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
        return
    fi

    echo -e "${CYAN}Select database container:${NC}"
    i=1
    for container in $containers; do
        name=${container% -db}
        name=${name#odoo-}
        echo "  $i) $name"
        ((i++))
    done

    echo ""
    echo -ne "${CYAN}Select container number: ${NC}"
    read -r choice

    container=$(echo "$containers" | sed -n "${choice}p")
    if [ -z "$container" ]; then
        echo -e "${RED}Invalid selection${NC}"
        sleep 2
        return
    fi

    echo ""
    echo -ne "${CYAN}Number of lines [100]: ${NC}"
    read -r lines
    lines=${lines:-100}

    clear
    print_header
    echo -e "${BOLD}Logs: ${container#odoo-}${NC}"
    echo ""
    echo -e "${DIM}(Press 'q' to return to menu)${NC}"
    echo ""

    # Show logs with pagination
    docker logs --tail "$lines" "$container" 2>/dev/null | less -R || docker logs --tail "$lines" "$container" 2>/dev/null

    echo ""
    echo -ne "${YELLOW}Press Enter to continue...${NC}"
    read -r
}

# Follow logs live
follow_logs() {
    clear
    print_header
    echo -e "${BOLD}Follow Logs (Live)${NC}"
    echo ""

    if ! check_docker; then
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
        return
    fi

    # Get instances
    containers=$(docker ps --filter "name=odoo-" --format "{{.Names}}" 2>/dev/null || true)

    if [ -z "$containers" ]; then
        echo -e "${YELLOW}No running instances found${NC}"
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
        return
    fi

    echo -e "${CYAN}Select instance:${NC}"
    i=1
    for container in $containers; do
        name=${container#odoo-}
        echo "  $i) $name"
        ((i++))
    done

    echo ""
    echo -ne "${CYAN}Select instance number: ${NC}"
    read -r choice

    instance=$(echo "$containers" | sed -n "${choice}p")
    if [ -z "$instance" ]; then
        echo -e "${RED}Invalid selection${NC}"
        sleep 2
        return
    fi

    clear
    print_header
    echo -e "${BOLD}Following logs: ${instance#odoo-}${NC}"
    echo ""
    echo -e "${DIM}(Press Ctrl+C to stop)${NC}"
    echo ""

    # Follow logs
    docker logs -f "$instance" 2>/dev/null

    echo ""
    echo -ne "${YELLOW}Press Enter to continue...${NC}"
    read -r
}

# Git Operations submenu
git_menu() {
    while true; do
        clear
        print_header
        echo -e "${BOLD}Git Operations${NC}"
        echo ""
        echo -e "  ${GREEN}1)${NC} Clone repository"
        echo -e "  ${GREEN}2)${NC} List repositories"
        echo -e "  ${GREEN}3)${NC} Checkout branch"
        echo -e "  ${GREEN}4)${NC} Pull changes"
        echo -e "  ${GREEN}5)${NC} Repository status"
        echo -e "  ${YELLOW}0)${NC} Back to main menu"
        echo ""
        echo -ne "${CYAN}Select option: ${NC}"
        read -r choice

        case $choice in
            1) git_clone ;;
            2) git_list_repos ;;
            3) git_checkout ;;
            4) git_pull ;;
            5) git_status ;;
            0) return ;;
            *) echo -e "${RED}Invalid option${NC}"; sleep 1 ;;
        esac
    done
}

# Clone repository
git_clone() {
    clear
    print_header
    echo -e "${BOLD}Clone Repository${NC}"
    echo ""

    echo -ne "${CYAN}Repository URL: ${NC}"
    read -r repo_url

    if [ -z "$repo_url" ]; then
        echo -e "${RED}URL cannot be empty${NC}"
        sleep 2
        return
    fi

    # Extract name from URL
    repo_name=$(basename "$repo_url" .git)

    echo ""
    echo -ne "${CYAN}Repository name [$repo_name]: ${NC}"
    read -r name_input
    repo_name=${name_input:-$repo_name}

    echo ""
    echo -ne "${CYAN}Branch [master]: ${NC}"
    read -r branch
    branch=${branch:-master}

    # Clone
    echo ""
    echo -e "${CYAN}Cloning repository...${NC}"

    if git clone -b "$branch" "$repo_url" "$REPOS_DIR/$repo_name" 2>/dev/null; then
        echo ""
        echo -e "${GREEN}✓ Repository cloned${NC}"
        echo "  Location: $REPOS_DIR/$repo_name"
    else
        echo ""
        echo -e "${RED}✗ Failed to clone repository${NC}"
    fi

    echo ""
    echo -ne "${YELLOW}Press Enter to continue...${NC}"
    read -r
}

# List repositories
git_list_repos() {
    clear
    print_header
    echo -e "${BOLD}Git Repositories${NC}"
    echo ""

    if [ ! -d "$REPOS_DIR" ] || [ -z "$(ls -A $REPOS_DIR)" ]; then
        echo -e "${YELLOW}No repositories found${NC}"
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
        return
    fi

    for repo_dir in "$REPOS_DIR"/*; do
        if [ -d "$repo_dir" ]; then
            name=$(basename "$repo_dir")

            # Get branch
            if [ -d "$repo_dir/.git" ]; then
                branch=$(cd "$repo_dir" && git branch --show-current 2>/dev/null)
                commit=$(cd "$repo_dir" && git log -1 --format="%h" 2>/dev/null)
                remote=$(cd "$repo_dir" && git remote get-url origin 2>/dev/null || echo "No remote")

                echo -e "${CYAN}$name${NC}"
                echo "  Branch: $branch"
                echo "  Commit: $commit"
                echo "  Remote: $remote"
                echo ""
            fi
        fi
    done 2>/dev/null

    echo -ne "${YELLOW}Press Enter to continue...${NC}"
    read -r
}

# Checkout branch
git_checkout() {
    clear
    print_header
    echo -e "${BOLD}Checkout Branch${NC}"
    echo ""

    # Select repository
    repos=()
    for repo_dir in "$REPOS_DIR"/*; do
        if [ -d "$repo_dir/.git" ]; then
            repos+=("$(basename "$repo_dir")")
        fi
    done 2>/dev/null

    if [ ${#repos[@]} -eq 0 ]; then
        echo -e "${YELLOW}No repositories found${NC}"
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
        return
    fi

    echo -e "${CYAN}Select repository:${NC}"
    i=1
    for repo in "${repos[@]}"; do
        echo "  $i) $repo"
        ((i++))
    done

    echo ""
    echo -ne "${CYAN}Select repository number: ${NC}"
    read -r choice

    repo="${repos[$((choice-1))]}"
    repo_path="$REPOS_DIR/$repo"

    # List branches
    echo ""
    echo -e "${CYAN}Available branches:${NC}"
    cd "$repo_path" || return

    git branch 2>/dev/null | sed 's/*//' | sed 's/HEAD -> /   Detached at /' | nl

    echo ""
    echo -ne "${CYAN}Branch name: ${NC}"
    read -r branch

    if [ -z "$branch" ]; then
        cd - > /dev/null
        return
    fi

    # Checkout
    if git checkout "$branch" 2>/dev/null; then
        echo ""
        echo -e "${GREEN}✓ Checked out branch '$branch'${NC}"

        # Show commit info
        commit=$(git log -1 --format="%h - %s" 2>/dev/null)
        echo "  Commit: $commit"
    else
        echo ""
        echo -e "${RED}✗ Failed to checkout branch${NC}"
    fi

    cd - > /dev/null

    echo ""
    echo -ne "${YELLOW}Press Enter to continue...${NC}"
    read -r
}

# Pull changes
git_pull() {
    clear
    print_header
    echo -e "${BOLD}Pull Changes${NC}"
    echo ""

    # Select repository
    repos=()
    for repo_dir in "$REPOS_DIR"/*; do
        if [ -d "$repo_dir/.git" ]; then
            repos+=("$(basename "$repo_dir")")
        fi
    done 2>/dev/null

    if [ ${#repos[@]} -eq 0 ]; then
        echo -e "${YELLOW}No repositories found${NC}"
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
        return
    fi

    echo -e "${CYAN}Select repository:${NC}"
    i=1
    for repo in "${repos[@]}"; do
        echo "  $i) $repo"
        ((i++))
    done

    echo ""
    echo -ne "${CYAN}Select repository number: ${NC}"
    read -r choice

    repo="${repos[$((choice-1))]}"
    repo_path="$REPOS_DIR/$repo"

    # Pull
    echo ""
    echo -e "${CYAN}Pulling latest changes...${NC}"

    cd "$repo_path" || return

    if git pull 2>/dev/null; then
        echo ""
        echo -e "${GREEN}✓ Pulled latest changes${NC}"

        # Show commit info
        commit=$(git log -1 --format="%h - %s" 2>/dev/null)
        echo "  Latest: $commit"
    else
        echo ""
        echo -e "${RED}✗ Failed to pull${NC}"
    fi

    cd - > /dev/null

    echo ""
    echo -ne "${YELLOW}Press Enter to continue...${NC}"
    read -r
}

# Repository status
git_status() {
    clear
    print_header
    echo -e "${BOLD}Repository Status${NC}"
    echo ""

    # Select repository
    repos=()
    for repo_dir in "$REPOS_DIR"/*; do
        if [ -d "$repo_dir/.git" ]; then
            repos+=("$(basename "$repo_dir")")
        fi
    done 2>/dev/null

    if [ ${#repos[@]} -eq 0 ]; then
        echo -e "${YELLOW}No repositories found${NC}"
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
        return
    fi

    echo -e "${CYAN}Select repository:${NC}"
    i=1
    for repo in "${repos[@]}"; do
        echo "  $i) $repo"
        ((i++))
    done

    echo ""
    echo -ne "${CYAN}Select repository number: ${NC}"
    read -r choice

    repo="${repos[$((choice-1))]}"
    repo_path="$REPOS_DIR/$repo"

    cd "$repo_path" || return

    clear
    print_header
    echo -e "${BOLD}Status: $repo${NC}"
    echo ""

    # Show status
    echo -e "${CYAN}Current branch:${NC} $(git branch --show-current 2>/dev/null)"
    echo ""
    echo -e "${CYAN}Recent commits:${NC}"
    git log -5 --oneline --decorate 2>/dev/null || echo "No commits"
    echo ""

    # Check if dirty
    if ! git diff-index --quiet HEAD -- 2>/dev/null; then
        echo -e "${YELLOW}Uncommitted changes:${NC}"
        git status --short 2>/dev/null
    else
        echo -e "${GREEN}Working directory is clean${NC}"
    fi

    cd - > /dev/null

    echo ""
    echo -ne "${YELLOW}Press Enter to continue...${NC}"
    read -r
}

# Monitoring submenu
monitor_menu() {
    while true; do
        clear
        print_header
        echo -e "${BOLD}Monitoring & Health${NC}"
        echo ""
        echo -e "  ${GREEN}1)${NC} System status"
        echo -e "  ${GREEN}2)${NC} Instance health check"
        echo -e "  ${GREEN}3)${NC} Resource usage"
        echo -e "  ${GREEN}4)${NC} View recent errors"
        echo -e "  ${YELLOW}0)${NC} Back to main menu"
        echo ""
        echo -ne "${CYAN}Select option: ${NC}"
        read -r choice

        case $choice in
            1) system_status ;;
            2) health_check ;;
            3) resource_usage ;;
            4) view_errors ;;
            0) return ;;
            *) echo -e "${RED}Invalid option${NC}"; sleep 1 ;;
        esac
    done
}

# System status
system_status() {
    clear
    print_header
    echo -e "${BOLD}System Status${NC}"
    echo ""

    # Docker status
    echo -e "${CYAN}Docker:${NC}"
    if docker info &> /dev/null; then
        echo -e "  ${GREEN}✓ Running${NC}"
    else
        echo -e "  ${RED}✗ Not running${NC}"
    fi

    # Docker compose
    compose_cmd=$(check_docker_compose)
    if [ -n "$compose_cmd" ]; then
        echo "  Compose: $compose_cmd"
    else
        echo "  Compose: ${YELLOW}Not available${NC}"
    fi

    # Disk usage
    echo ""
    echo -e "${CYAN}Disk Usage:${NC}"
    df -h | head -5

    # Memory
    echo ""
    echo -e "${CYAN}Memory:${NC}"
    if command -v free &> /dev/null; then
        free -h | head -5
    else
        vm_stat | head -5
    fi

    echo ""
    echo -ne "${YELLOW}Press Enter to continue...${NC}"
    read -r
}

# Health check
health_check() {
    clear
    print_header
    echo -e "${BOLD}Instance Health Check${NC}"
    echo ""

    if ! check_docker; then
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
        return
    fi

    # Get instances
    containers=$(docker ps -a --filter "name=odoo-" --format "{{.Names}}" 2>/dev/null || true)

    if [ -z "$containers" ]; then
        echo -e "${YELLOW}No instances found${NC}"
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
        return
    fi

    printf "%-20s %-10s %-10s\n" "Instance" "Status" "Health"
    printf "%-20s %-10s %-10s\n" "--------" "------" "------"

    for container in $containers; do
        name=${container#odoo-}

        # Status
        if docker ps --filter "name=$container" --format "{{.Names}}" | grep -q "$container"; then
            status="${GREEN}Running${NC}"
        else
            status="${RED}Stopped${NC}"
        fi

        # Health
        if docker ps --filter "name=$container" --format "{{.State}}" | grep -q "running"; then
            health="${GREEN}Healthy${NC}"
        elif docker ps --filter "name=$container" --format "{{.State}}" | grep -q "exited"; then
            # Check exit code
            exit_code=$(docker inspect "$container" --format '{{.State.ExitCode}}' 2>/dev/null)
            if [ "$exit_code" = "0" ]; then
                health="${GREEN}Healthy${NC}"
            else
                health="${RED}Failed (exit $exit_code)${NC}"
            fi
        else
            health="${YELLOW}Unknown${NC}"
        fi

        printf "%-20s %-20s %-10s\n" "$name" "$status" "$health"
    done

    echo ""
    echo -ne "${YELLOW}Press Enter to continue...${NC}"
    read -r
}

# Resource usage
resource_usage() {
    clear
    print_header
    echo -e "${BOLD}Resource Usage${NC}"
    echo ""

    if ! check_docker; then
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
        return
    fi

    # Get running containers
    containers=$(docker ps --filter "name=odoo-" --format "{{.Names}}" 2>/dev/null || true)

    if [ -z "$containers" ]; then
        echo -e "${YELLOW}No running instances found${NC}"
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
        return
    fi

    echo -e "${CYAN}Resource usage (live - refreshes every 5s, press q to quit):${NC}"
    echo ""

    while true; do
        clear
        print_header
        echo -e "${BOLD}Resource Usage${NC}"
        echo ""

        printf "%-20s %-10s %-15s %-15s\n" "Instance" "CPU %" "Memory" "Network I/O"
        printf "%-20s %-10s %-15s %-15s\n" "--------" "------" "-------" "-----------"

        for container in $containers; do
            name=${container#odoo-}

            # Get stats
            stats=$(docker stats "$container" --no-stream --format "{{.CPUPerc}},{{.MemUsage}},{{.NetIO}}" 2>/dev/null)

            if [ -n "$stats" ]; then
                IFS=',' read -r cpu mem io <<< "$stats"
                printf "%-20s %-10s %-15s %-15s\n" "$name" "$cpu" "$mem" "$io"
            fi
        done

        echo ""
        echo -e "${DIM}Refreshing in 5 seconds (press q to quit)...${NC}"

        # Check for 'q' key with timeout
        if read -t 5 -n 1 key && [[ "$key" == "q" ]]; then
            break
        fi
    done

    echo ""
    echo -ne "${YELLOW}Press Enter to continue...${NC}"
    read -r
}

# View recent errors
view_errors() {
    clear
    print_header
    echo -e "${BOLD}Recent Errors in Logs${NC}"
    echo ""

    if ! check_docker; then
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
        return
    fi

    # Get running instances
    containers=$(docker ps --filter "name=odoo-" --format "{{.Names}}" 2>/dev/null || true)

    if [ -z "$containers" ]; then
        echo -e "${YELLOW}No running instances found${NC}"
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
        return
    fi

    echo -e "${CYAN}Select instance:${NC}"
    i=1
    for container in $containers; do
        name=${container#odoo-}
        echo "  $i) $name"
        ((i++))
    done

    echo ""
    echo -ne "${CYAN}Select instance number: ${NC}"
    read -r choice

    instance=$(echo "$containers" | sed -n "${choice}p")
    if [ -z "$instance" ]; then
        echo -e "${RED}Invalid selection${NC}"
        sleep 2
        return
    fi

    clear
    print_header
    echo -e "${BOLD}Recent Errors: ${instance#odoo-}${NC}"
    echo ""

    # Get logs and filter for errors
    docker logs --tail 100 "$instance" 2>/dev/null | grep -i "error\|exception\|critical" || echo "No errors found in recent logs"

    echo ""
    echo -ne "${YELLOW}Press Enter to continue...${NC}"
    read -r
}

# Configuration menu
config_menu() {
    while true; do
        clear
        print_header
        echo -e "${BOLD}Configuration${NC}"
        echo ""
        echo -e "  ${GREEN}1)${NC} Show configuration"
        echo -e "  ${GREEN}2)${NC} Edit default settings"
        echo -e "  ${GREEN}3)${NC} View locations"
        echo -e "  ${YELLOW}0)${NC} Back to main menu"
        echo ""
        echo -ne "${CYAN}Select option: ${NC}"
        read -r choice

        case $choice in
            1) show_config ;;
            2) edit_config ;;
            3) view_locations ;;
            0) return ;;
            *) echo -e "${RED}Invalid option${NC}"; sleep 1 ;;
        esac
    done
}

# Show configuration
show_config() {
    clear
    print_header
    echo -e "${BOLD}Configuration${NC}"
    echo ""

    echo -e "${CYAN}Locations:${NC}"
    echo "  Config:  $CONFIG_DIR"
    echo "  Data:    $DATA_DIR"
    echo "  Backups: $BACKUP_DIR"
    echo "  Logs:    $LOG_DIR"
    echo "  Repos:   $REPOS_DIR"

    echo ""
    echo -e "${CYAN}Default Settings:${NC}"
    echo "  Default edition:  community"
    echo "  Default deployment: docker"
    echo "  Default Odoo version: master"

    echo ""
    echo -e "${CYAN}PostgreSQL:${NC}"
    echo "  Default host: localhost"
    echo "  Default port: 5432"
    echo "  Default user: odoo"

    echo ""
    echo -e "${CYAN}Backup:${NC}"
    echo "  Retention days: 30"
    echo "  Compression: gzip"

    echo ""
    echo -ne "${YELLOW}Press Enter to continue...${NC}"
    read -r
}

# Edit configuration
edit_config() {
    clear
    print_header
    echo -e "${BOLD}Edit Configuration${NC}"
    echo ""

    config_file="$CONFIG_DIR/config.yaml"

    if [ ! -f "$config_file" ]; then
        echo "Config file doesn't exist. Would you like to create it? [y/N]"
        read -r create_config

        if [[ "$create_config" =~ ^[Yy]$ ]]; then
            mkdir -p "$CONFIG_DIR"
            cat > "$config_file" <<EOF
# Odoo Manager Configuration
settings:
  data_dir: ~/odoo-manager/data
  backup_dir: ~/odoo-manager/backups
  log_dir: ~/odoo-manager/logs
  default_edition: community
  default_deployment: docker
  default_odoo_version: master

postgres:
  host: localhost
  port: 5432
  user: odoo
  password: odoo

backup:
  retention_days: 30
  compression: gzip
  format: dump
EOF
            echo "Created config file: $config_file"
        fi
    fi

    # Open in editor
    ${EDITOR:-nano} "$config_file" 2>/dev/null || vi "$config_file"

    echo ""
    echo -ne "${YELLOW}Press Enter to continue...${NC}"
    read -r
}

# View locations
view_locations() {
    clear
    print_header
    echo -e "${BOLD}File Locations${NC}"
    echo ""

    echo -e "${CYAN}Directories:${NC}"
    echo "  Config:  $CONFIG_DIR"
    echo "  Data:    $DATA_DIR"
    echo "  Backups: $BACKUP_DIR"
    echo "  Logs:    $LOG_DIR"
    echo "  Repos:   $REPOS_DIR"

    echo ""
    echo -e "${CYAN}Files:${NC}"
    echo "  Config:  $CONFIG_DIR/config.yaml"
    echo "  Instances: $CONFIG_DIR/instances.yaml"

    echo ""
    echo -ne "${YELLOW}Press Enter to continue...${NC}"
    read -r
}

# Main loop
main_loop() {
    while true; do
        print_menu
        echo -ne "${CYAN}Select option: ${NC}"
        read -r choice

        case $choice in
            1) instance_menu ;;
            2) database_menu ;;
            3) module_menu ;;
            4) database_menu ;;  # Backup is under database operations
            5) logs_menu ;;
            6) git_menu ;;
            7) monitor_menu ;;
            8) config_menu ;;
            0)
                clear
                echo -e "${GREEN}Thank you for using Odoo Manager!${NC}"
                exit 0
                ;;
            *)
                echo -e "${RED}Invalid option. Please try again.${NC}"
                sleep 1
                ;;
        esac
    done
}

# Script entry point
if [ "$1" = "--install" ]; then
    # Installation mode
    echo "Installing Odoo Manager script..."

    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    SCRIPT_NAME="odoo-manager-menu"

    # Copy to /usr/local/bin
    if [ "$EUID" -eq 0 ]; then
        cp "$SCRIPT_DIR/$SCRIPT_NAME" /usr/local/bin/odoo-manager
        chmod +x /usr/local/bin/odoo-manager
        echo "Installed to /usr/local/bin/odoo-manager"
        echo "You can now run: odoo-manager"
    else
        echo "Run with sudo to install system-wide:"
        echo "  sudo $0 --install"
    fi
elif [ "$1" = "--uninstall" ]; then
    # Uninstall mode
    if [ "$EUID" -eq 0 ]; then
        rm -f /usr/local/bin/odoo-manager
        echo "Uninstalled from /usr/local/bin/odoo-manager"
    else
        echo "Run with sudo to uninstall:"
        echo "  sudo $0 --uninstall"
    fi
else
    # Normal mode - run the menu
    main_loop
fi
