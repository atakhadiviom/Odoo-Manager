version: '3.8'

services:
  odoo:
    image: {{ odoo_image }}
    container_name: {{ container_names.odoo }}
    depends_on:
      - postgres
    ports:
      - "{{ instance.port }}:8069"
    environment:
      HOST: {{ db_host }}
      PORT: {{ db_port }}
      USER: {{ postgres_user }}
      PASSWORD: {{ postgres_password }}
    volumes:
      - odoo-data:/var/lib/odoo
      - ./addons:/mnt/extra-addons
    restart: unless-stopped
    command: --
      --db-host={{ db_host }}
      --db-port={{ db_port }}
      --db-user={{ postgres_user }}
      --db-password={{ postgres_password }}
      --db-filter={{ instance.db_filter }}
      --workers={{ instance.workers }}
      --max-cron-threads={{ instance.max_cron_threads }}
      --db-maxconn={{ instance.db_maxconn }}
      --admin-password={{ instance.admin_password }}
      {% if instance.addons_path %}--addons-path={{ instance.addons_path }}{% endif %}
      --without-demo={{ instance.without_demo | lower }}

  postgres:
    image: {{ postgres_image }}
    container_name: {{ container_names.postgres }}
    environment:
      POSTGRES_USER: {{ postgres_user }}
      POSTGRES_PASSWORD: {{ postgres_password }}
      POSTGRES_DB: {{ postgres_db }}
    volumes:
      - db-data:/var/lib/postgresql/data
    restart: unless-stopped

volumes:
  odoo-data:
  db-data:
